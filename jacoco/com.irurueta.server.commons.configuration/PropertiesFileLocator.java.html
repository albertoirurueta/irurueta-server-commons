<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PropertiesFileLocator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">irurueta-server-commons</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.server.commons.configuration</a> &gt; <span class="el_source">PropertiesFileLocator.java</span></div><h1>PropertiesFileLocator.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2016 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.server.commons.configuration;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.servlet.ServletContext;

/**
 * This class searches for a properties file in the root of the classpath of
 * the deployed war or at the server user home directory.
 * @param &lt;T&gt; type of object to be used to locate a resource.
 */
public class PropertiesFileLocator&lt;T&gt; {
    
    /**
     * Logger for this class.
     */
<span class="fc" id="L37">    private static final Logger LOGGER = Logger.getLogger(</span>
            PropertiesFileLocator.class.getName());
    
    /**
     * Default name to search for if none is provided.
     */
    public static final String DEFAULT_FILE_NAME = &quot;configuration.properties&quot;;
    
    /**
     * Reference to servlet context where application is running.
     */
    private ServletContext mContext;
    
    /**
     * Reference to an object where resources can be looked in its library jar
     * or war file.
     */
    private T mSource; //source object. This is used to search a resource on
                      //a given jar o war where the class belongs to
    
    /**
     * Properties file name containing configuration.
     */
    private String mFileName;   
    
    /**
     * Constructor.
     * @param fileName properties file name containing configuration.
     */
<span class="fc" id="L66">    public PropertiesFileLocator(String fileName){</span>
<span class="fc" id="L67">        mContext = null;</span>
<span class="fc" id="L68">        mSource = null;</span>
<span class="fc" id="L69">        mFileName = fileName;</span>
<span class="fc" id="L70">    }</span>
    
    /**
     * Constructor.
     * @param source reference to an object where resources can be loaded in its
     * library jar or war file.
     */
<span class="fc" id="L77">    public PropertiesFileLocator(T source){</span>
<span class="fc" id="L78">        mContext = null;</span>
<span class="fc" id="L79">        mSource = source;</span>
<span class="fc" id="L80">        mFileName = DEFAULT_FILE_NAME;</span>
<span class="fc" id="L81">    }</span>
    
    /**
     * Constructor.
     * @param context reference to servlet context where application is running.
     * @param source reference to an object where resources can be loaded in its
     * library jar or war file.
     */
<span class="fc" id="L89">    public PropertiesFileLocator(ServletContext context, T source){</span>
<span class="fc" id="L90">        mContext = context;</span>
<span class="fc" id="L91">        mSource = source;</span>
<span class="fc" id="L92">        mFileName = DEFAULT_FILE_NAME;</span>
<span class="fc" id="L93">    }</span>
    
    /**
     * Constructor.
     * @param source reference to an object where resources can be loaded in its
     * library jar or war file.
     * @param fileName properties file name containing configuration.
     */
<span class="fc" id="L101">    public PropertiesFileLocator(T source, String fileName){</span>
<span class="fc" id="L102">        mContext = null;</span>
<span class="fc" id="L103">        mSource = source;</span>
<span class="fc" id="L104">        mFileName = fileName;</span>
<span class="fc" id="L105">    }</span>
    
    /**
     * Constructor.
     * @param context reference to servlet context where application is running.
     * @param source reference to an object where resources can be loaded in its
     * library jar or war file.
     * @param fileName properties file name containing configuration.
     */
    public PropertiesFileLocator(ServletContext context, T source, 
<span class="fc" id="L115">            String fileName){</span>
<span class="fc" id="L116">        mContext = context;</span>
<span class="fc" id="L117">        mSource = source;</span>
<span class="fc" id="L118">        mFileName = fileName;        </span>
<span class="fc" id="L119">    }</span>
           
    /**
     * Locates properties configuration based on provided parameters.
     * First properties are searched based on applicaiton context name, then
     * on user home and finally within a war or jar file.
     * @return properties configuration.
     * @throws IOException if an I/O error occurs.
     */
    public Properties locate() throws IOException{
        //properties file was found
<span class="fc" id="L130">        Properties props = new Properties();</span>
<span class="fc" id="L131">        InputStream stream = locateResource();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if(stream != null){</span>
<span class="fc" id="L133">            props.load(stream);</span>
        }
<span class="fc" id="L135">        return props;</span>
    }
    
    /**
     * Internal method to search for configuration file and return its 
     * corresponding input stream.
     * @return input stream corresponding to configuration file.
     * @throws IOException if an I/O error occurs.
     */
    private InputStream locateResource() throws IOException{        
        //get server user home location
<span class="fc" id="L146">        String home = System.getProperty(&quot;user.home&quot;);</span>
        //for windows replace \ with /
<span class="fc" id="L148">        home = home.replaceAll(&quot;\\\\&quot;, &quot;/&quot;);</span>
        
<span class="fc" id="L150">        LOGGER.log(Level.INFO, &quot;User home folder: {0}&quot;, home);  </span>
        
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if(mContext != null){</span>
            //Attempt to retrieve first properties files in home path with
            //same name as application context
<span class="nc" id="L155">            String contextPath = mContext.getContextPath();</span>
            String path;
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if(!contextPath.isEmpty()){</span>
<span class="nc" id="L158">                path = &quot;~&quot; + contextPath + &quot;.properties&quot;;</span>
<span class="nc" id="L159">                path = path.replaceAll(&quot;~&quot;, home);</span>
            
<span class="nc" id="L161">                File f = new File(path);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if(f.exists()){</span>
<span class="nc" id="L163">                    LOGGER.log(Level.INFO, &quot;Properties file: {0}&quot;, path);</span>
<span class="nc" id="L164">                    return new FileInputStream(f);</span>
                }
            }        
        }
        
        //if not found, then attempt to find file at user home
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        if(mFileName != null){</span>
<span class="fc" id="L171">            File f = new File(home, mFileName);</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">            if(f.exists()){</span>
<span class="nc" id="L173">                LOGGER.log(Level.INFO, &quot;Properties file: {0}&quot;, f.getPath());</span>
<span class="nc" id="L174">                return new FileInputStream(f);</span>
            }
        }
        
        //if no file is found, then attempt to search it within war file        
<span class="fc" id="L179">        InputStream stream = null;</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if(mSource != null){</span>
<span class="fc" id="L181">            stream = mSource.getClass().getResourceAsStream(mFileName);</span>
        
<span class="fc bfc" id="L183" title="All 2 branches covered.">            if(stream == null){</span>
                //no properties file was found
<span class="fc" id="L185">                LOGGER.log(Level.INFO, &quot;Properties file not found.&quot;);</span>
            }
        }
<span class="fc" id="L188">        return stream;        </span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>